import subprocess
import json
import os
import webbrowser

# Function to run shell script and get output
def run_shell_script(script):
    result = subprocess.run(["bash", script], capture_output=True, text=True)
    try:
        return json.loads(result.stdout)  # Parse JSON output
    except json.JSONDecodeError:
        print("Error: Could not decode shell script response.")
        return None

# Step 1: Fetch repositories
data = run_shell_script("fetch_repos.sh")

if not data or "repositories" not in data:
    print("Error fetching repositories!")
    exit(1)

repositories = [repo["name"] for repo in data["repositories"]]

# Step 2: Display repositories and ask for user input
print("\nFetched Repositories:")
for i, repo in enumerate(repositories, 1):
    print(f"{i}. {repo}")

project_name = input("\nEnter the project name you want to search for: ").strip()

# Step 3: Check if project exists
if project_name in repositories:
    print("✅ Yes, found it!")
    
    # Ask if user wants to list files
    list_files = input("Do you want to list all files & folders? (yes/no): ").strip().lower()
    
    if list_files == "yes":
        # Step 4: Run shell command to list files
        list_command = f"find /path/to/repos/{project_name} -type d"
        file_list = subprocess.run(list_command, shell=True, capture_output=True, text=True)

        folders = file_list.stdout.strip().split("\n")

        # Step 5: Generate HTML output
        html_content = """<!DOCTYPE html>
        <html>
        <head>
            <title>Project Files</title>
        </head>
        <body>
            <h2>Folders in Project: {}</h2>
            <ul>
        """.format(project_name)

        for folder in folders:
            html_content += f"        <li>{folder}</li>\n"

        html_content += """    </ul>
        </body>
        </html>"""

        # Save to an HTML file
        with open("files.html", "w") as f:
            f.write(html_content)

        print("✅ HTML file 'files.html' has been generated!")
        webbrowser.open("files.html")  # Open HTML file in browser
    else:
        print("Job done. Exiting.")
else:
    print("❌ No such project found.")





#!/bin/bash

# Define API credentials and base URL
API_URL="https://serverstash.server.com/rest/api1.0/projects/ABC/repos"
AUTH_TOKEN="BE2234434343CDD"
LIMIT=100  
START=0    

declare -a REPOS  

# Initialize JSON structure
echo '{ "repositories": ['

FIRST=true

while true; do
    response=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" \
                      -H "Content-Type: application/json" \
                      "$API_URL?limit=$LIMIT&start=$START")

    for repo_name in $(echo "$response" | jq -r '.values[].name'); do
        if [ "$FIRST" = true ]; then
            FIRST=false
        else
            echo ","
        fi
        echo -n "  { \"name\": \"$repo_name\" }"
        REPOS+=("$repo_name")
    done

    is_last_page=$(echo "$response" | jq -r '.isLastPage')
    if [ "$is_last_page" == "true" ]; then
        break
    fi

    START=$(echo "$response" | jq -r '.nextPageStart')
done

echo " ] }"
