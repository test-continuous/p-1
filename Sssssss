#!/bin/bash

Define API credentials and base URL

API_URL="https://serverstash.server.com/rest/api1.0/projects/ABC/repos" AUTH_TOKEN="BE2234434343CDD"

Predefined name-value pairs to check inside YAML files

REQUIRED_PAIRS=( "- name: example-name1" "- value: example-value1" "- name: example-name2" "- value: example-value2" "- name: example-name3" "- value: example-value3" )

Function to fetch and check YAML file content

function check_yaml_content { local project_name="$1" local file_path="$2"

# Fetch file content
content=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" \
                -H "Content-Type: application/json" \
                "$API_URL/$project_name/raw/$file_path")

# Check if all predefined pairs exist in the content
for pair in "${REQUIRED_PAIRS[@]}"; do
    if ! grep -q "$pair" <<< "$content"; then
        echo "❌ Content Not Available in: $file_path"
        return
    fi
done
echo "✅ Content Available in: $file_path"

}

Function to search for matching YAML files containing 'statefulset'

function search_yaml_files { local project_name="$1" local base_path="$2" local pattern="$3"

response=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" \
                  -H "Content-Type: application/json" \
                  "$API_URL/$project_name/browse/$base_path")

if [[ "$response" == *"errors"* ]]; then
    return
fi

files=($(echo "$response" | grep -o '"name":"[^"]*\.yaml"' | sed -E 's/"name":"([^"]+)"/\1/'))

for file in "${files[@]}"; do
    if [[ "$file" == *"$pattern"* ]]; then
        # Fetch the file content to check for 'statefulset'
        file_content=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" \
                              -H "Content-Type: application/json" \
                              "$API_URL/$project_name/raw/$base_path/$file")
        
        if [[ "$file_content" == *"statefulset"* ]]; then
            echo "🔍 Found matching file: $API_URL/$project_name/browse/$base_path/$file"
            check_yaml_content "$project_name" "$base_path/$file"
        fi
    fi
done

}

Recursive function to explore directories

function search_in_directory { local project_name="$1" local base_path="$2" local pattern="$3"

response=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" \
                  -H "Content-Type: application/json" \
                  "$API_URL/$project_name/browse/$base_path")

if [[ "$response" == *"errors"* ]]; then
    return
fi

directories=($(echo "$response" | grep -o '"name":"[^"]*"' | sed -E 's/"name":"([^"]+)"/\1/'))

for dir in "${directories[@]}"; do
    full_path="$base_path/$dir"
    search_yaml_files "$project_name" "$full_path" "$pattern" &
    search_in_directory "$project_name" "$full_path" "$pattern" &
done
wait

}

Function to start search inside k8s/envs/pr/

function search_pr_folders { local project_name="$1" local pattern="$2" local base_path="k8s/envs/pr"

response=$(curl -s -H "Authorization: Bearer $AUTH_TOKEN" \
                  -H "Content-Type: application/json" \
                  "$API_URL/$project_name/browse/$base_path")

if [[ "$response" == *"errors"* ]]; then
    echo "Base path does not exist: $base_path"
    return
fi

folders=($(echo "$response" | grep -o '"name":"[^"]*"' | sed -E 's/"name":"([^"]+)"/\1/'))

for folder in "${folders[@]}"; do
    search_in_directory "$project_name" "$base_path/$folder" "$pattern" &
done
wait

}

Prompt user for input

read -p "Enter the project name: " project_name read -p "Enter the pattern to search for in YAML files: " pattern

search_pr_folders "$project_name" "$pattern"

